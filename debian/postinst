#!/bin/sh
# postinst script for jicofo

set -e

_configure() {
	CONFIG="/etc/jitsi/jicofo/config"

	# we don't want to start the daemon as root
	if ! getent group jitsi > /dev/null ; then
        	groupadd jitsi
        fi

	if ! getent passwd jicofo > /dev/null ; then
		useradd -r -g jitsi --shell /bin/bash --create-home -d /usr/share/jicofo jicofo
        fi

	if ! groups jicofo | grep '\bjitsi\b' > /dev/null ; then
		usermod -g jitsi jicofo
	fi

	mkdir -p /usr/share/jicofo

	# we claim the home folder of jicofo in case it is owned by someone else
	OWNER=$(stat -c '%U' /usr/share/jicofo)
	GROUP=$(stat -c '%G' /usr/share/jicofo)
	if ! dpkg-statoverride --list /usr/share/jicofo/* >/dev/null \
	&& [ "$OWNER:$GROUP" != "jicofo:jitsi" ]
	then
		chown -R jicofo:jitsi /usr/share/jicofo
		OWNER=jicofo
		GROUP=jitsi
	fi

	CONFIG_DIR=$(dirname $CONFIG)
	if ! dpkg-statoverride --list "$CONFIG_DIR" >/dev/null; then
		chown -R jicofo:jitsi "$CONFIG_DIR"
		chmod 750 "$CONFIG_DIR"
	fi

	# die logz
	if [ ! -d /var/log/jitsi ]
	then
		mkdir -p /var/log/jitsi
		chown $OWNER:$GROUP /var/log/jitsi
		chmod 770 /var/log/jitsi
	fi

	ls /var/log/jitsi/jicofo* 1>/dev/null 2>&1 \
		&& chown -f -R $OWNER:$GROUP /var/log/jitsi/jicofo*
	ls /var/log/jitsi/jicofo* 1>/dev/null 2>&1 \
		&& chmod -f -R 640 /var/log/jitsi/jicofo*

	# clean up old jicofo group
	if getent group jicofo > /dev/null 
	then
		groupdel jicofo
	fi
}

_wildcard() {
	echo "postinst called with unknown argument \`$1'" >&2
        exit 1
}

case "$1" in
	configure) _configure;;
	abort-upgrade|abort-remove|abort-deconfigure) ;;
	*) _wildcard;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
